# 中断服务函数机制

## 1 启动文件定义中断向量表

首先 HAL 库层会在启动文件中配置中断服务例程（ISR），启动文件中会定义一个中断向量表，通常是一个数组，其中每个元素对应一个中断服务例程（ISR）的地址。

```assembly

g_pfnVectors:
    .word  _estack          /* 初始栈指针 */
    .word  Reset_Handler    /* 复位处理函数 */
    .word  NMI_Handler      /* NMI 处理函数 */
    .word  HardFault_Handler /* 硬故障处理函数 */
    /* 其他中断处理函数 */
    .word  USART2_IRQHandler /* USART2 中断处理函数 */
    /* 继续定义其他中断 */

```

## 2 中断文件规定服务函数入口

```C
void USART2_IRQHandler(void)
{

  HAL_UART_IRQHandler(&huart2);

}
```

上面的启动文件规定中断向量表后，触发`USART2_IRQHandler(void)`**中断服务例程（ISR，Interrupt Service Routine）**，ISR 中再调用`HAL_UART_IRQHandler(&huart2);
`，他是一个中断服务函数，中断处理函数，主要负责中断触发逻辑业务，例如清空标志位，**触发何种回调函数等**。

## 3 中断处理函数

该函数 `HAL_UART_IRQHandler` 是一个用于处理 UART（通用异步收发传输器）中断请求的回调函数。它的主要作用是根据 UART 的状态和配置，处理接收和发送数据的中断，以及处理可能出现的错误。以下是对该函数的详细解释：

### 函数参数
- `UART_HandleTypeDef *huart`: 指向 UART 句柄的指针，包含 UART 的状态、配置和数据缓冲区等信息。

### 函数流程

1. **读取状态寄存器**:
   - 使用 `READ_REG` 宏读取 UART 的状态寄存器（ISR）和控制寄存器（CR1 和 CR3），获取当前的中断标志和配置。

2. **错误处理**:
   - 检查是否有错误发生（如奇偶校验错误、帧错误、噪声错误、溢出错误等）。
   - 如果没有错误，检查接收中断是否被使能，并调用接收中断服务例程（`RxISR`）。

3. **处理错误**:
   - 如果发生了错误，清除相应的错误标志，并更新错误代码。
   - 根据错误的类型（如奇偶校验错误、帧错误等），进行相应的处理。
   - 如果错误是阻塞性的（如接收超时或溢出），则结束接收过程，并可能调用 DMA 相关的中断处理。
   - 如果错误是非阻塞性的，则通过用户定义的回调函数通知用户。

4. **接收模式检查**:
   - 如果 UART 处于接收模式，并且接收到 IDLE 事件，则处理 IDLE 事件，并可能调用相应的回调函数。

5. **处理唤醒事件**:
   - 如果 UART 从停止模式唤醒，清除唤醒标志，并调用唤醒回调函数。

6. **发送模式处理**:
   - 如果 UART 处于发送模式，检查发送中断是否被使能，并调用发送中断服务例程（`TxISR`）。
   - 处理发送完成中断（TC）和发送 FIFO 空的情况，调用相应的回调函数。

### 总结
该函数是 UART 中断处理的核心，负责管理接收和发送数据的中断事件，处理各种错误，并通过回调函数通知用户。通过合理的中断处理，可以实现高效的数据通信，确保数据的完整性和可靠性。